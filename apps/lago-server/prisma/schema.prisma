// Lago 数据库 Schema
// 使用 npm 运行 prisma 命令

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== 小程序端用户体系 ====================

enum UserRole {
  user // 住户/个人卖家
  merchant // 商家
  property // 物业
  admin // 平台管理员（小程序端）
}

model User {
  id            String   @id @default(cuid())
  wechatOpenid  String?  @unique
  wechatUnionid String?
  nickname      String?
  avatarUrl     String?
  phone         String?  @unique
  email         String?  @unique
  password      String? // 密码哈希（用于手机号登录）
  role          UserRole @default(user)
  creditScore   Int      @default(100) // 信用积分
  isVerified    Boolean  @default(false) // 是否实名认证
  isActive      Boolean  @default(true) // 账号状态
  communityIds  String[] // 加入的小区ID数组

  // 关联关系
  products       Product[]
  ordersAsBuyer  Order[]          @relation("Buyer")
  ordersAsSeller Order[]          @relation("Seller")
  chatRooms      ChatRoomMember[]
  messages       ChatMessage[]
  notifications  Notification[]
  settlements    Settlement[]
  communities    UserCommunity[] // 加入的小区
  onboardingApplications OnboardingApplication[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([wechatOpenid])
  @@index([phone])
  @@index([role])
  @@map("users")
}

// ==================== 运营系统账号体系 ====================

model OperationStaff {
  id          String        @id @default(cuid())
  username    String        @unique // 用户名
  email       String        @unique
  password    String // 密码哈希
  realName    String? // 真实姓名
  phone       String? // 手机号
  isActive    Boolean       @default(true) // 账号状态
  isSuperAdmin Boolean      @default(false)
  lastLoginAt DateTime? // 最后登录时间
  lastLoginIp String? // 最后登录IP

  // 关联关系
  operationLogs OperationLog[]
  loginLogs     LoginLog[]
  roles         OperationStaffRole[]
  onboardingReviews OnboardingApplication[] @relation("OnboardingReviewer")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([username])
  @@index([email])
  @@index([isSuperAdmin])
  @@map("operation_staffs")
}

model OperationPermission {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  category    String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rolePermissions OperationRolePermission[]

  @@map("operation_permissions")
}

model OperationRole {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isSystem    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rolePermissions OperationRolePermission[]
  staffAssignments OperationStaffRole[]

  @@map("operation_roles")
}

model OperationRolePermission {
  id           String             @id @default(cuid())
  roleId       String
  permissionId String
  createdAt    DateTime           @default(now())

  role       OperationRole       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission OperationPermission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("operation_role_permissions")
}

model OperationStaffRole {
  id        String         @id @default(cuid())
  staffId   String
  roleId    String
  assignedAt DateTime      @default(now())

  staff OperationStaff @relation(fields: [staffId], references: [id], onDelete: Cascade)
  role  OperationRole  @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([staffId, roleId])
  @@map("operation_staff_roles")
}

model OnboardingApplication {
  id                     String           @id @default(cuid())
  userId                 String
  user                   User             @relation(fields: [userId], references: [id])
  type                   OnboardingType
  serviceCategory        ServiceCategory?
  status                 OnboardingStatus @default(pending)
  fullName               String?
  idNumber               String?
  businessName           String?
  businessLicenseNumber  String?
  contactPhone           String?
  contactEmail           String?
  address                String?
  description            String?
  experienceYears        Int?
  documents              Json?
  metadata               Json?
  submittedAt            DateTime         @default(now())
  reviewedAt             DateTime?
  reviewerId             String?
  reviewer               OperationStaff?  @relation("OnboardingReviewer", fields: [reviewerId], references: [id])
  rejectReason           String?
  createdAt              DateTime         @default(now())
  updatedAt              DateTime         @updatedAt

  @@index([userId])
  @@index([status])
  @@index([type])
  @@map("onboarding_applications")
}

// ==================== 省市区体系 ====================

model Province {
  id        String  @id @default(cuid())
  code      String  @unique // 省份代码
  name      String  @unique // 省份名称
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  // 关联关系
  cities       City[]
  communities  Community[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("provinces")
}

model City {
  id         String  @id @default(cuid())
  provinceId String
  code       String  @unique // 城市代码
  name       String // 城市名称
  sortOrder  Int     @default(0)
  isActive   Boolean @default(true)

  // 关联关系
  province   Province   @relation(fields: [provinceId], references: [id])
  districts  District[]
  communities Community[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([provinceId])
  @@map("cities")
}

model District {
  id        String  @id @default(cuid())
  cityId    String
  code      String  @unique // 区县代码
  name      String // 区县名称
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  // 关联关系
  city       City        @relation(fields: [cityId], references: [id])
  communities Community[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cityId])
  @@map("districts")
}

// ==================== 社区体系 ====================

enum CommunityVerificationStatus {
  pending   // 待认证（尚未提交材料）
  processing // 待审核（已提交，审核中）
  approved  // 已认证
  rejected  // 已拒绝
}

// ==================== 入驻体系 ====================

enum OnboardingType {
  personal_seller            // 个人卖家（实名认证）
  small_business_seller      // 小微卖家（个体户资料）
  personal_service_provider  // 个人服务商（实名认证）
  enterprise_service_provider // 企业服务商（工商资料）
}

enum OnboardingStatus {
  pending     // 填写中（草稿）
  processing  // 待审核
  approved    // 已通过
  rejected    // 已拒绝
}

enum ServiceCategory {
  recycling                // 废品回收
  appliance_repair         // 家电维修
  appliance_install        // 家电安装
  appliance_cleaning       // 家电清洗
  furniture_repair         // 家具维修
  carpentry                // 木工
  masonry                  // 泥工/砌筑
  tiling                   // 瓦工/贴砖
  painting                 // 油漆翻新
  plumbing                 // 管道疏通/水电维修
  electrician              // 电工服务
  hvac_install             // 暖通空调安装维护
  locksmith                // 开锁换锁
  pest_control             // 除虫除害
  cleaning                 // 专业保洁
  moving_service           // 搬家搬运
  landscaping              // 园艺绿化
  decoration_design        // 装修设计
  renovation_general       // 整体改造
  other                    // 其他
}

model Community {
  id          String  @id @default(cuid())
  name        String // 小区名称
  location    String // 地理位置（经纬度 "lat,lng"）
  address     String? // 详细地址
  provinceId  String? // 省份ID
  cityId      String? // 城市ID
  districtId  String? // 区县ID
  partnerId   String? // 合作物业ID（User role=property）
  geoHash     String? // 地理位置哈希，用于距离计算
  images      String[] // 小区相册
  description String? // 小区介绍
  verificationStatus CommunityVerificationStatus @default(pending) // 认证状态
  verifiedAt  DateTime? // 认证时间
  verifiedBy  String? // 认证审核人ID（OperationStaff）
  isActive    Boolean @default(true)

  // 关联关系
  province    Province?            @relation(fields: [provinceId], references: [id])
  city        City?                @relation(fields: [cityId], references: [id])
  district    District?            @relation(fields: [districtId], references: [id])
  products    Product[]
  liveEvents  LiveEvent[]          @relation("LiveEvents")
  activities  CommunityActivity[]
  members     UserCommunity[]
  verification CommunityVerification?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([provinceId])
  @@index([cityId])
  @@index([districtId])
  @@index([partnerId])
  @@index([geoHash])
  @@index([verificationStatus])
  @@map("communities")
}

// 用户-小区关联表（记录用户加入的小区）
model UserCommunity {
  id          String   @id @default(cuid())
  userId      String
  communityId String
  joinedAt    DateTime @default(now())
  isActive    Boolean  @default(true)

  // 关联关系
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)

  @@unique([userId, communityId])
  @@index([userId])
  @@index([communityId])
  @@map("user_communities")
}

// 小区认证申请表
model CommunityVerification {
  id          String   @id @default(cuid())
  communityId String  @unique
  companyName String  // 物业公司名称
  contactName String  // 联系人姓名
  contactPhone String // 联系人电话
  licenseUrl  String  // 营业执照URL
  proofUrl    String? // 其他证明资料URL
  status      CommunityVerificationStatus @default(pending)
  rejectReason String? // 拒绝原因
  reviewedBy  String? // 审核人ID（OperationStaff）
  reviewedAt  DateTime? // 审核时间

  // 关联关系
  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@map("community_verifications")
}

// 小区活动
enum CommunityActivityType {
  announcement // 公告
  market       // 摆摊
  festival     // 过节
  event        // 活动
  other        // 其他
}

enum CommunityActivityStatus {
  draft      // 草稿
  published  // 已发布
  ended      // 已结束
  cancelled  // 已取消
}

model CommunityActivity {
  id          String                 @id @default(cuid())
  communityId String
  creatorId   String // 创建人ID（User role=property）
  type        CommunityActivityType
  title       String // 活动标题
  description String? // 活动描述
  images      String[] // 活动图片
  startTime   DateTime? // 开始时间
  endTime     DateTime? // 结束时间
  location    String? // 活动地点
  status      CommunityActivityStatus @default(draft)
  viewCount   Int     @default(0) // 浏览次数
  participantCount Int @default(0) // 参与人数

  // 关联关系
  community Community @relation(fields: [communityId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([communityId])
  @@index([status])
  @@index([type])
  @@map("community_activities")
}

// ==================== 商品系统 ====================

enum ProductCategoryEnum {
  toys
  gaming
}

enum TransactionType {
  rent
  sell
  both
}

enum ProductStatus {
  pending
  active
  sold
  rented
  offline
}

model Product {
  id          String              @id @default(cuid())
  ownerId     String // 卖家ID
  communityId String? // 所属小区ID
  title       String // 商品标题
  description String? // 商品描述
  category    ProductCategoryEnum // toys | gaming
  type        TransactionType // rent | sell | both
  price       Decimal             @db.Decimal(10, 2) // 售价/租金
  deposit     Decimal?            @db.Decimal(10, 2) // 押金（租赁）
  images      String[] // 商品图片数组
  status      ProductStatus       @default(pending)
  location    String? // 地理位置
  geoHash     String? // 地理位置哈希
  isVerified  Boolean             @default(false) // 是否认证商品
  viewCount   Int                 @default(0) // 浏览次数
  likeCount   Int                 @default(0) // 收藏次数

  // 关联关系
  owner     User       @relation(fields: [ownerId], references: [id])
  community Community? @relation(fields: [communityId], references: [id])
  orders    Order[]
  chatRooms ChatRoom[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])
  @@index([communityId])
  @@index([status])
  @@index([geoHash])
  @@map("products")
}

// ==================== 订单系统 ====================

enum OrderType {
  rent
  sell
}

enum OrderStatus {
  pending
  paid
  confirmed
  completed
  cancelled
  refunded
}

enum DeliveryType {
  self_pickup
  delivery
  cabinet
}

model Order {
  id              String       @id @default(cuid())
  productId       String // 商品ID
  buyerId         String // 买家ID
  sellerId        String // 卖家ID
  type            OrderType // rent | sell
  amount          Decimal      @db.Decimal(10, 2) // 订单金额
  deposit         Decimal?     @db.Decimal(10, 2) // 押金（租赁）
  status          OrderStatus  @default(pending)
  startDate       DateTime? // 租赁开始日期
  endDate         DateTime? // 租赁结束日期
  deliveryType    DeliveryType // self_pickup | delivery | cabinet
  deliveryAddress String? // 配送地址
  remark          String? // 备注

  // 关联关系
  product       Product      @relation(fields: [productId], references: [id])
  buyer         User         @relation("Buyer", fields: [buyerId], references: [id])
  seller        User         @relation("Seller", fields: [sellerId], references: [id])
  depositRecord Deposit?
  settlements   Settlement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@map("orders")
}

enum RefundStatus {
  pending
  refunded
  forfeited
}

model Deposit {
  id           String       @id @default(cuid())
  orderId      String       @unique
  amount       Decimal      @db.Decimal(10, 2) // 押金金额
  refundStatus RefundStatus @default(pending)
  refundedAt   DateTime? // 退款时间

  // 关联关系
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("deposits")
}

// ==================== 聊天系统 ====================

model ChatRoom {
  id        String  @id @default(cuid())
  productId String? // 关联商品ID（商品聊天）
  type      String  @default("private") // private | group
  isActive  Boolean @default(true)

  // 关联关系
  product  Product?         @relation(fields: [productId], references: [id])
  members  ChatRoomMember[]
  messages ChatMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@map("chat_rooms")
}

model ChatRoomMember {
  id         String @id @default(cuid())
  chatRoomId String
  userId     String

  // 关联关系
  chatRoom ChatRoom @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([chatRoomId, userId])
  @@index([userId])
  @@map("chat_room_members")
}

enum MessageType {
  text
  image
  system
  product_card
}

model ChatMessage {
  id         String      @id @default(cuid())
  chatRoomId String
  senderId   String
  receiverId String?
  type       MessageType @default(text)
  content    String // 消息内容
  fileUrl    String? // 文件URL（图片等）
  productId  String? // 关联商品ID（商品卡片）
  isRead     Boolean     @default(false)

  // 关联关系
  chatRoom ChatRoom @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  sender   User     @relation(fields: [senderId], references: [id])

  createdAt DateTime  @default(now())
  readAt    DateTime?

  @@index([chatRoomId])
  @@index([senderId])
  @@index([receiverId])
  @@map("chat_messages")
}

// ==================== 直播活动系统 ====================

enum LiveEventStatus {
  scheduled
  live
  ended
}

model LiveEvent {
  id          String          @id @default(cuid())
  communityId String
  hostId      String // 主持人ID（User）
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime?
  streamUrl   String?
  status      LiveEventStatus @default(scheduled)
  viewCount   Int             @default(0)

  // 关联关系
  community Community @relation("LiveEvents", fields: [communityId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([communityId])
  @@index([status])
  @@map("live_events")
}

// ==================== 财务结算系统 ====================

enum SettlementType {
  order
  refund
  commission
}

enum SettlementStatus {
  pending
  completed
  failed
}

model Settlement {
  id          String           @id @default(cuid())
  userId      String
  orderId     String?
  type        SettlementType
  amount      Decimal          @db.Decimal(10, 2)
  status      SettlementStatus @default(pending)
  completedAt DateTime?

  // 关联关系
  user  User   @relation(fields: [userId], references: [id])
  order Order? @relation(fields: [orderId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([orderId])
  @@index([status])
  @@map("settlements")
}

// ==================== 通知系统 ====================

enum NotificationType {
  order
  message
  system
}

model Notification {
  id          String           @id @default(cuid())
  userId      String
  type        NotificationType
  title       String
  content     String
  relatedId   String? // 相关实体ID
  relatedType String? // 相关实体类型
  isRead      Boolean          @default(false)

  // 关联关系
  user User @relation(fields: [userId], references: [id])

  createdAt DateTime  @default(now())
  readAt    DateTime?

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

// ==================== 其他表 ====================

model ProductCategory {
  id        String  @id @default(cuid())
  name      String  @unique
  slug      String  @unique
  icon      String?
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("product_categories")
}

// ==================== 运营系统日志 ====================

model OperationLog {
  id         String  @id @default(cuid())
  staffId    String
  action     String // 操作类型
  targetType String? // 操作对象类型
  targetId   String? // 操作对象ID
  details    String? // 操作详情（JSON）
  ip         String?
  userAgent  String?

  // 关联关系
  staff OperationStaff @relation(fields: [staffId], references: [id])

  createdAt DateTime @default(now())

  @@index([staffId])
  @@index([targetType, targetId])
  @@index([createdAt])
  @@map("operation_logs")
}

model LoginLog {
  id        String  @id @default(cuid())
  staffId   String
  ip        String?
  userAgent String?
  success   Boolean @default(true)
  reason    String? // 失败原因

  // 关联关系
  staff OperationStaff @relation(fields: [staffId], references: [id])

  createdAt DateTime @default(now())

  @@index([staffId])
  @@index([success])
  @@index([createdAt])
  @@map("login_logs")
}
