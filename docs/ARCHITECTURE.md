# Lago 架构设计文档

> **重要**: 本文档描述完整的前后端架构设计，包括技术栈选型、模块划分和通信机制。

## 🏗️ 项目概述

Lago 是一个基于 Next.js 14 + Express.js 的全栈应用，社区二手租售平台。采用前后端分离架构，支持 Web、小程序等多端访问。

## 🛠️ 技术栈

### 前端技术栈

- **框架**: Next.js 14 (App Router)
- **UI 库**: React 18 + TypeScript
- **样式**: Tailwind CSS + CSS Variables
- **动画**: Framer Motion
- **状态管理**: React Context + Zustand
- **数据请求**: TanStack Query (React Query)
- **表单验证**: class-validator
- **实时通信**: Socket.IO Client

### 后端技术栈

- **运行时**: Node.js 18+ + TypeScript
- **框架**: Express.js
- **数据库**: PostgreSQL 14+
- **ORM**: Prisma 5+
- **缓存**: Redis 7+
- **认证**: JWT + bcrypt
- **验证**: class-validator + class-transformer
- **API 文档**: Swagger/OpenAPI
- **实时通信**: Socket.IO
- **AI 服务**: 阿里云通义千问 (智能推荐、搜索、客服)
- **虚拟号服务**: 第三方虚拟号服务 (保护隐私沟通)
- **文件存储**: 阿里云 OSS / 腾讯云 COS

### 开发工具

- **代码检查**: ESLint + Prettier
- **类型检查**: TypeScript
- **测试**: Jest + Testing Library
- **构建**: Webpack 5 (Next.js) + tsc (Express)

### 组件设计原则

1. **移动优先**: 优先考虑小程序和移动端体验
2. **简洁现代**: 去除复杂装饰，专注功能和内容
3. **一致性**: 统一的设计语言和交互模式
4. **可访问性**: 支持无障碍访问和多设备适配

## 🏛️ 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                         客户端层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   Web应用    │  │  微信小程序   │  │  桌面应用     │      │
│  │  (Next.js)   │  │   (计划中)    │  │  (Tauri)     │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└────────────┬────────────────────────────────────────────────┘
             │
             │ HTTPS / WebSocket
             │
┌────────────▼────────────────────────────────────────────────┐
│                         API网关层                             │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              Express.js API Server                    │   │
│  │  ┌───────────┐  ┌────────────┐  ┌────────────┐     │   │
│  │  │   路由    │  │  中间件     │  │  控制器    │     │   │
│  │  │  Routes   │  │ Middleware  │  │ Controllers│     │   │
│  │  └───────────┘  └────────────┘  └────────────┘     │   │
│  └──────────────────────────────────────────────────────┘   │
└────────────┬────────────────────────────────────────────────┘
             │
             │
┌────────────▼────────────────────────────────────────────────┐
│                         业务逻辑层                            │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ 商品服务  │  │ AI服务    │  │ 虚拟号服务│  │ 通知服务 │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ 订单服务  │  │ 社区服务  │  │ 支付服务 │  │ 循环柜服务│   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└────────────┬────────────────────────────────────────────────┘
             │
             │
┌────────────▼────────────────────────────────────────────────┐
│                         数据访问层                            │
│  ┌────────────────────────────────────────────────────┐     │
│  │              Prisma ORM Client                      │     │
│  └────────────────────────────────────────────────────┘     │
└────────────┬────────────────────────────────────────────────┘
             │
    ┌────────┴────────┐
    │                 │
┌───▼────┐      ┌────▼────┐      ┌──────────┐
│PostgreSQL│    │  Redis  │      │阿里云OSS  │
│  数据库  │    │  缓存   │      │文件存储   │
└─────────┘    └─────────┘      └──────────┘
```

### 前后端通信

#### HTTP API 通信

```
前端 -> API请求 -> Express路由 -> 控制器 -> 服务层 -> 数据库
                                                        ↓
前端 <- JSON响应 <---------------------------- 统一响应格式
```

#### WebSocket 实时通信

```
前端 -> Socket.IO Client -> Socket.IO Server -> 消息处理
                                                    ↓
前端 <- 实时推送 <---------------------- 广播/私聊消息
```

## 🚀 开发工作流

### 本地开发

```bash
npm run dev          # 启动开发服务器
npm run lint         # 代码检查
npm run type-check   # 类型检查
npm run test         # 运行测试
```

### 生产构建

```bash
npm run build        # 构建生产版本
npm run start        # 启动生产服务器
```

### 代码质量

```bash
npm run format       # 格式化代码
npm run lint:fix     # 自动修复 lint 问题
npm run test:coverage # 测试覆盖率报告
```

## 📋 开发规范

### 组件开发

1. **函数式组件**: 优先使用函数式组件和 Hooks
2. **TypeScript**: 所有组件必须有完整的类型定义
3. **响应式设计**: 组件必须支持多种屏幕尺寸
4. **可测试性**: 组件应该易于单元测试

### 样式规范

1. **Tailwind 优先**: 优先使用 Tailwind 工具类
2. **CSS Variables**: 使用 CSS 变量定义主题色彩
3. **移动优先**: 采用移动优先的响应式设计
4. **性能优化**: 避免不必要的重绘和重排

### API 集成

1. **类型安全**: 所有 API 调用都有完整的类型定义
2. **错误处理**: 统一的错误处理和用户反馈
3. **缓存策略**: 合理使用 React Query 缓存
4. **实时更新**: 通过 WebSocket 实现实时数据同步

## 🎯 性能优化

### 已实施的优化

- ✅ **代码分割**: Next.js 自动代码分割
- ✅ **图片优化**: Next.js Image 组件优化
- ✅ **缓存策略**: React Query 数据缓存
- ✅ **懒加载**: 组件和路由懒加载

### 计划中的优化

- 🚧 **虚拟滚动**: 长列表性能优化
- 🚧 **预加载**: 关键路由预加载
- 🚧 **离线支持**: Service Worker 离线缓存
- 🚧 **CDN 优化**: 静态资源 CDN 分发

## 🔐 安全考虑

### 客户端安全

- ✅ **输入验证**: 客户端输入验证和清理
- ✅ **XSS 防护**: React 内置 XSS 防护
- ✅ **CSRF 防护**: API 请求 CSRF 令牌
- ✅ **权限控制**: 基于角色的权限验证

### 数据安全

- ✅ **敏感数据**: 不在客户端存储敏感信息
- ✅ **加密传输**: HTTPS 加密数据传输
- ✅ **令牌管理**: JWT 令牌安全管理
- ✅ **会话控制**: 自动会话过期和刷新

### 生产环境

- 错误边界和错误上报
- 性能指标监控
- 用户行为分析
- API 调用统计

---
